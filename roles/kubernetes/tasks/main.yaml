- name: Install MicroK8s via snap
  snap:
    name: microk8s
    state: present
    classic: yes
  become: yes

- name: Add user to microk8s group
  user:
    name: "{{ ansible_user }}"
    groups: microk8s
    append: yes

- name: Allow iptables to see bridged traffic
  shell: |
    sudo iptables -P FORWARD ACCEPT
  become: yes

- name: Enable necessary MicroK8s add-ons
  shell: |
    microk8s enable dns storage ingress

- name: Wait for MicroK8s to be ready
  shell: |
    microk8s status --wait-ready
